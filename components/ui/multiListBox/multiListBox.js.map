{"version":3,"file":"multiListBox.js","sourceRoot":"../../..","sources":["components/ui/multiListBox/multiListBox.tsx"],"sourcesContent":["import * as dom from \"ux/dom\";\r\nimport keyPress from \"ux/keyPress\";\r\nimport { scrollIntoViewIfNeeded } from \"ux/scroll\";\r\nimport Control, { VNode, bind, NodeLike, from } from \"ui/control\";\r\nimport Input from \"ui/input\";\r\nimport { ListBoxBase, ListItem } from \"ui/listBox\";\r\n\r\n/**\r\n * 表示一个多选列表框。\r\n */\r\nexport default class MultiListBox extends ListBoxBase {\r\n\r\n    /**\r\n     * 所有选中项。\r\n     */\r\n    get selectedItems() {\r\n        return this.query(\".x-listbox>.x-listbox-selected\") as ListItem[];\r\n    }\r\n    set selectedItems(value) {\r\n        this.selectedItems.forEach(item => { item.selected = false; });\r\n        if (value) value.forEach(item => { item.selected = true; });\r\n    }\r\n\r\n    /**\r\n     * 值。\r\n     */\r\n    get value() {\r\n        return this.selectedItems.map(item => item.key);\r\n    }\r\n    set value(value) {\r\n        this.items.forEach(item => {\r\n            item.selected = !!value && (value as string[]).indexOf(item.key) >= 0;\r\n        });\r\n    }\r\n\r\n    protected init() {\r\n        super.init();\r\n        dom.on(this.body, \"pointerdown\", \"li\", this.handlePointerDown, this);\r\n        keyPress(this.elem, this.keyMap());\r\n    }\r\n\r\n    /**\r\n     * 如果为 true 则仅当按下 Ctrl 时才为多选模式。否则默认为单选模式。\r\n     */\r\n    ctrlKey: boolean;\r\n\r\n    /**\r\n     * 处理指针按下事件。\r\n     */\r\n    protected handlePointerDown(e: MouseEvent, item: HTMLElement) {\r\n        e.preventDefault();\r\n        if (!this.disabled && !this.readOnly) {\r\n            dom.on(document, \"pointerup\", this.handlePointerUp, this);\r\n            dom.on(this.body, \"pointerenter\", \"li\", this.handlePointerMove, this);\r\n            item = from(item) as any;\r\n            this.select(e.shiftKey ? this._lastClickItem : item, item, this._lastSelected = !(item as any as ListItem).selected, this._ctrlKeyPressed = !!(e.ctrlKey || e.metaKey) === !!this.ctrlKey, e);\r\n            this._lastClickItem = item as any as ListItem;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 存储最后一次点击的项。\r\n     */\r\n    private _lastClickItem: ListItem;\r\n\r\n    /**\r\n     * 存储是否使用多选模式。\r\n     */\r\n    private _ctrlKeyPressed: boolean;\r\n\r\n    /**\r\n     * 存储最后一次选则状态。\r\n     */\r\n    private _lastSelected: boolean;\r\n\r\n    /**\r\n     * 处理指针移动事件。\r\n     */\r\n    protected handlePointerMove(e: MouseEvent, item: HTMLElement) {\r\n        this.select(this._lastClickItem, item, this._lastSelected, this._ctrlKeyPressed, e);\r\n    }\r\n\r\n    /**\r\n     * 处理指针松开事件。\r\n     */\r\n    protected handlePointerUp(e: MouseEvent) {\r\n        dom.off(this.body, \"pointerenter\", \"li\", this.handlePointerMove, this);\r\n        dom.off(document, \"pointerup\", this.handlePointerUp, this);\r\n    }\r\n\r\n    /**\r\n     * 选中项。\r\n     * @param start 选区的第一个节点。\r\n     * @param end 选区的最后一个节点。默认同 *from*。\r\n     * @param value 如果为 true 则表示选中，如果为 false 则表示不选中。\r\n     * @param add 如果为 true 则合并之前选中的项，否则为替代。\r\n     * @param e 事件参数。\r\n     */\r\n    select(start: ListItem | NodeLike | null, end = start, value = true, add?: boolean, e?: UIEvent) {\r\n        const items = this.items;\r\n        const last = from(end) as ListItem;\r\n        let startIndex = items.indexOf(from(start) as ListItem);\r\n        let endIndex = items.indexOf(last);\r\n        if (startIndex > endIndex) {\r\n            const t = startIndex;\r\n            startIndex = endIndex;\r\n            endIndex = t;\r\n        }\r\n        let changed = false;\r\n        for (let i = 0; i < items.length; i++) {\r\n            const item = items[i];\r\n            if (i >= startIndex && i <= endIndex) {\r\n                if (!this.onSelect || this.onSelect(item, value, e!, this) !== false) {\r\n                    if (item.selected !== value) {\r\n                        item.selected = value;\r\n                        changed = true;\r\n                    }\r\n                }\r\n            } else if (!add && value && item.selected === value && (!this.onSelect || this.onSelect(item, !value, e!, this) !== false)) {\r\n                item.selected = !value;\r\n                changed = true;\r\n            }\r\n        }\r\n        if (last) {\r\n            scrollIntoViewIfNeeded(last.elem, this.body, this.duration);\r\n        }\r\n        if (changed && this.onChange) {\r\n            this.onChange(e!, this);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 即将选中事件。\r\n     * @param item 要选中的项。\r\n     * @param value 如果为 true 则表示选中，如果为 false 则表示不选中。\r\n     * @param e 事件参数。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则阻止选中事件。\r\n     */\r\n    onSelect: (item: ListItem, value: boolean, e: UIEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 获取键盘绑定。\r\n     * @return 返回各个键盘绑定对象。\r\n     */\r\n    keyMap() {\r\n        const upDown = (e: KeyboardEvent, delta: number) => {\r\n            const items = this.items as ListItem[];\r\n            const selectedItem = delta < 0 ? this.selectedItem : this.selectedItems[this.selectedItems.length - 1];\r\n            let newSelected: ListItem;\r\n            if (selectedItem) {\r\n                if (!(newSelected = items[items.indexOf(selectedItem) + delta])) {\r\n                    return true;\r\n                }\r\n                this.select(newSelected, undefined, !newSelected.selected, !this.ctrlKey || e.shiftKey || e.ctrlKey || e.metaKey);\r\n            } else {\r\n                this.select(newSelected = items[delta > 0 ? 0 : items.length - 1], undefined, undefined, undefined, e);\r\n            }\r\n        };\r\n        return {\r\n            up(e: KeyboardEvent) {\r\n                upDown(e, -1);\r\n            },\r\n            down(e: KeyboardEvent) {\r\n                upDown(e, 1);\r\n            }\r\n        };\r\n    }\r\n\r\n}\r\n"],"mappings":"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"}