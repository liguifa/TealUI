{"version":3,"file":"listBox.js","sourceRoot":"../../..","sources":["components/ui/listBox/listBox.tsx"],"sourcesContent":["import * as dom from \"ux/dom\";\r\nimport { scrollIntoViewIfNeeded } from \"ux/scroll\";\r\nimport keyPress from \"ux/keyPress\";\r\nimport Control, { VNode, bind, NodeLike, from } from \"ui/control\";\r\nimport Input from \"ui/input\";\r\nimport \"./listBox.scss\";\r\n\r\n/**\r\n * 表示一个列表框基类。\r\n */\r\nexport abstract class ListBoxBase extends Input {\r\n\r\n    protected render() {\r\n        return <ul class=\"x-listbox\"></ul>;\r\n    }\r\n\r\n    @bind(\"\") body: HTMLElement;\r\n\r\n    @bind(\"\", \"class\", \"x-listbox-readonly\") readOnly: boolean;\r\n\r\n    @bind(\"\", \"class\", \"x-listbox-disabled\") disabled: boolean;\r\n\r\n    /**\r\n     * 所有项。\r\n     */\r\n    get items() {\r\n        return this.query(\".x-listbox>li\") as ListItem[];\r\n    }\r\n    set items(value) {\r\n        this.body.innerHTML = \"\";\r\n        if (Array.isArray(value)) {\r\n            for (const item of value) {\r\n                if (item instanceof ListItem) {\r\n                    item.renderTo(this as any);\r\n                } else {\r\n                    const listItem = new ListItem();\r\n                    listItem.content = item;\r\n                    listItem.renderTo(this as any);\r\n                }\r\n            }\r\n        } else {\r\n            for (const key in value as any) {\r\n                const item = new ListItem();\r\n                item.key = key;\r\n                item.content = (value as any)[key];\r\n                item.renderTo(this as any);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 选中的第一项。\r\n     */\r\n    get selectedItem() {\r\n        return this.find(\".x-listbox>.x-listbox-selected\") as ListItem | null | undefined;\r\n    }\r\n    set selectedItem(value) {\r\n        const old = this.selectedItem;\r\n        if (old) old.selected = false;\r\n        if (value) value.selected = true;\r\n    }\r\n\r\n    /**\r\n     * 选中的第一项的索引。\r\n     */\r\n    get selectedIndex() {\r\n        const item = this.selectedItem;\r\n        return item ? dom.index(item.elem) : -1;\r\n    }\r\n    set selectedIndex(value) {\r\n        this.selectedItem = value >= 0 ? this.items[value] : null;\r\n    }\r\n\r\n    /**\r\n     * 获取指定键对应的项。\r\n     * @param key 要查询的键。\r\n     * @return 返回匹配的第一个项。如果不存在则返回 undefined。 \r\n     */\r\n    findItemByKey(key: string) {\r\n        return this.items.find(x => x.key === key);\r\n    }\r\n\r\n    /**\r\n     * 获取指定值对应的项。\r\n     * @param content 要查询的键。\r\n     * @return 返回匹配的第一个项。如果不存在则返回 undefined。 \r\n     */\r\n    findItemByContent(content: string) {\r\n        return this.items.find(x => x.content === content);\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * 表示一个列表框。\r\n */\r\nexport default class ListBox extends ListBoxBase {\r\n\r\n    /**\r\n     * 值。\r\n     */\r\n    get value() {\r\n        const item = this.selectedItem;\r\n        if (item) {\r\n            return item.key;\r\n        }\r\n        return null;\r\n    }\r\n    set value(value) {\r\n        this.selectedItem = this.findItemByKey(value!)!;\r\n    }\r\n\r\n    protected init() {\r\n        super.init();\r\n        dom.on(this.body, \"click\", \"li\", this.handleClick, this);\r\n        keyPress(this.elem, this.keyMappings());\r\n    }\r\n\r\n    /**\r\n     * 处理指针按下事件。\r\n     */\r\n    protected handleClick(e: MouseEvent, item: HTMLElement) {\r\n        if (!this.disabled && !this.readOnly) {\r\n            this.select(item, e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 选中项。\r\n     * @param item 要选中的项。\r\n     * @param e 事件参数。\r\n     */\r\n    select(item: NodeLike | ListItem | null, e?: UIEvent) {\r\n        item = from(item);\r\n        if (!this.onSelect || this.onSelect(item as ListItem, e!, this) !== false) {\r\n            const changed = this.selectedItem !== item;\r\n            if (changed) {\r\n                this.selectedItem = item as ListItem | null;\r\n            }\r\n            if (item) {\r\n                scrollIntoViewIfNeeded((item as ListItem).elem, this.body, this.duration);\r\n            }\r\n            if (changed && this.onChange) {\r\n                this.onChange(e!, this);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 即将选中事件。\r\n     * @param item 要选中的项。\r\n     * @param multiple 是否为多选模式。\r\n     * @param e 事件参数。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则阻止选中事件。\r\n     */\r\n    onSelect: (item: ListItem, e: UIEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 获取键盘绑定。\r\n     * @return 返回各个键盘绑定对象。\r\n     */\r\n    keyMappings() {\r\n        const upDown = (e: KeyboardEvent, delta: number) => {\r\n            const items = this.items;\r\n            if (items.length) {\r\n                let index = this.selectedIndex + delta;\r\n                if (index < 0) index += items.length;\r\n                if (index >= items.length) index = 0;\r\n                this.select(items[index], e);\r\n            }\r\n        };\r\n        return {\r\n            up(e: KeyboardEvent) {\r\n                upDown(e, -1);\r\n            },\r\n            down(e: KeyboardEvent) {\r\n                upDown(e, 1);\r\n            }\r\n        };\r\n    }\r\n\r\n}\r\n\r\n/**\r\n * 表示一个列表项。\r\n */\r\nexport class ListItem extends Control {\r\n\r\n    protected render() {\r\n        return <li><a href=\"javascript:;\" draggable={false}></a></li>;\r\n    }\r\n\r\n    @bind(\"a\") body: HTMLElement;\r\n\r\n    /**\r\n     * 键。\r\n     */\r\n    get key() {\r\n        return this.elem.getAttribute(\"data-key\") || this.content;\r\n    }\r\n    set key(value) {\r\n        this.elem.setAttribute(\"data-key\", value);\r\n    }\r\n\r\n    /**\r\n     * 内容。\r\n     */\r\n    @bind(\"a\", \"textContent\") content: string;\r\n\r\n    /**\r\n     * 是否选中。\r\n     */\r\n    get selected() {\r\n        return dom.hasClass(this.elem, \"x-listbox-selected\");\r\n    }\r\n    set selected(value) {\r\n        dom.toggleClass(this.elem, \"x-listbox-selected\", value);\r\n        this.elem.setAttribute(\"aria-selected\", value.toString());\r\n    }\r\n\r\n}\r\n"],"mappings":"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"}