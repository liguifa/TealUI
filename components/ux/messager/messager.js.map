{"version":3,"file":"messager.js","sourceRoot":"../../..","sources":["components/ux/messager/messager.ts"],"sourcesContent":["// #todo\r\n\r\n/**\r\n * @author biqing\r\n * https://github.com/biqing/MessengerJS\r\n */\r\n\r\n\r\n\r\nfunction Messenger(win) {\r\n    // save the pointer to the window which is interacting with\r\n    this.win = win;\r\n    this.init();\r\n}\r\n\r\n// postMessage API is supported\r\nMessenger.prototype.init = function () {\r\n    var self = this;\r\n    var receiver = function (event) {\r\n        // Some IE-component browsers fails if you compare\r\n        // window objects with '===' or '!=='.\r\n        if (event.source != self.win) return;\r\n        (self.onmessage || function () { }).call(self, event.data);\r\n    };\r\n    if (window.addEventListener)\r\n        window.addEventListener('message', receiver, false);\r\n    else if (window.attachEvent)\r\n        window.attachEvent('onmessage', receiver);\r\n};\r\n\r\nMessenger.prototype.send = function (data) {\r\n    this.win.postMessage(data, '*');\r\n};\r\n\r\nMessenger.initInParent = function (frame) {\r\n    return new this(frame.contentWindow);\r\n};\r\n\r\nMessenger.initInIframe = function () {\r\n    return new this(window.parent);\r\n};\r\n\r\n// in IE, postMessage API is not supported\r\nif (!window.postMessage && window.attachEvent) {\r\n    // redefine the init method\r\n    Messenger.prototype.init = function () {\r\n        var isSameOrigin = false;\r\n        // test if the two document is same origin\r\n        try {\r\n            isSameOrigin = !!this.win.location.href;\r\n        } catch (ex) { }\r\n        if (isSameOrigin) {\r\n            this.send = this.sendForSameOrigin;\r\n            this.initForSameOrigin();\r\n            return;\r\n        }\r\n\r\n        // different origin case\r\n        // init the message queue, which can guarantee the messages won't be lost\r\n        this.queue = [];\r\n        if (window.parent == this.win) {\r\n            this.initForParent();\r\n        } else {\r\n            this.initForFrame();\r\n        }\r\n    };\r\n\r\n    Messenger.prototype.initForSameOrigin = function () {\r\n        var self = this;\r\n        document.attachEvent('ondataavailable', function (event) {\r\n            if (!event.eventType ||\r\n                event.eventType !== 'message' ||\r\n                event.eventSource != self.win)\r\n                return;\r\n            (self.onmessage || function () { }).call(self, event.eventData);\r\n        });\r\n    };\r\n\r\n    Messenger.prototype.sendForSameOrigin = function (data) {\r\n        var self = this;\r\n        setTimeout(function () {\r\n            var event = self.win.document.createEventObject();\r\n            event.eventType = 'message';\r\n            event.eventSource = window;\r\n            event.eventData = data;\r\n            self.win.document.fireEvent('ondataavailable', event);\r\n        });\r\n    };\r\n\r\n    // create two iframe in iframe page\r\n    Messenger.prototype.initForParent = function () {\r\n        var fragment = document.createDocumentFragment();\r\n        var style = 'width: 1px; height: 1px; position: absolute; left: -999px; top: -999px;';\r\n        var senderFrame = document.createElement('iframe');\r\n        senderFrame.style.cssText = style;\r\n        fragment.appendChild(senderFrame);\r\n        var receiverFrame = document.createElement('iframe');\r\n        receiverFrame.style.cssText = style;\r\n        fragment.appendChild(receiverFrame);\r\n\r\n        document.body.insertBefore(fragment, document.body.firstChild);\r\n        this.senderWin = senderFrame.contentWindow;\r\n        this.receiverWin = receiverFrame.contentWindow;\r\n\r\n        this.startReceive();\r\n    };\r\n\r\n    // parent page wait the messenger iframe is ready\r\n    Messenger.prototype.initForFrame = function () {\r\n        this.senderWin = null;\r\n        this.receiverWin = null;\r\n\r\n        var self = this;\r\n        this.timerId = setInterval(function () {\r\n            self.waitForFrame();\r\n        }, 50);\r\n    };\r\n\r\n    // parent page polling the messenger iframe\r\n    // when all is ready, start trying to receive message\r\n    Messenger.prototype.waitForFrame = function () {\r\n        var senderWin;\r\n        var receiverWin;\r\n        try {\r\n            senderWin = this.win[1];\r\n            receiverWin = this.win[0];\r\n        } catch (ex) { }\r\n        if (!senderWin || !receiverWin) return;\r\n        clearInterval(this.timerId);\r\n\r\n        this.senderWin = senderWin;\r\n        this.receiverWin = receiverWin;\r\n        if (this.queue.length)\r\n            this.flush();\r\n        this.startReceive();\r\n    };\r\n\r\n    // polling the messenger iframe's window.name\r\n    Messenger.prototype.startReceive = function () {\r\n        var self = this;\r\n        this.timerId = setInterval(function () {\r\n            self.tryReceive();\r\n        }, 50);\r\n    };\r\n\r\n    Messenger.prototype.tryReceive = function () {\r\n        try {\r\n            // If we can access name, we have already got the data.\r\n            this.receiverWin.name;\r\n            return;\r\n        } catch (ex) { }\r\n\r\n        // if the name property can not be accessed, try to change the messenger iframe's location to 'about blank'\r\n        this.receiverWin.location.replace('about:blank');\r\n        // We have to delay receiving to avoid access-denied error.\r\n        var self = this;\r\n        setTimeout(function () {\r\n            self.receive();\r\n        }, 0);\r\n    };\r\n\r\n    // recieve and parse the data, call the listener function\r\n    Messenger.prototype.receive = function () {\r\n        var rawData = null;\r\n        try {\r\n            rawData = this.receiverWin.name;\r\n        } catch (ex) { }\r\n        if (!rawData) return;\r\n        this.receiverWin.name = '';\r\n\r\n        var self = this;\r\n        var dataList = rawData.substring(1).split('|');\r\n        for (var i = 0; i < dataList.length; i++) (function () {\r\n            var data = decodeURIComponent(dataList[i]);\r\n            setTimeout(function () {\r\n                (self.onmessage || function () { }).call(self, data);\r\n            }, 0);\r\n        })();\r\n    };\r\n\r\n    // send data via push the data into the message queue\r\n    Messenger.prototype.send = function (data) {\r\n        this.queue.push(data);\r\n        if (!this.senderWin) return;\r\n        this.flush();\r\n    };\r\n\r\n    Messenger.prototype.flush = function () {\r\n        var dataList = [];\r\n        for (var i = 0; i < this.queue.length; i++)\r\n            dataList[i] = encodeURIComponent(this.queue[i]);\r\n        var encodedData = '|' + dataList.join('|');\r\n        try {\r\n            this.senderWin.name += encodedData;\r\n            this.queue.length = 0;\r\n        } catch (ex) {\r\n            this.senderWin.location.replace('about:blank');\r\n            var self = this;\r\n            setTimeout(function () {\r\n                self.flush();\r\n            }, 0);\r\n        }\r\n    };\r\n\r\n}"],"mappings":"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"}