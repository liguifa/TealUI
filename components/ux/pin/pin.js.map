{"version":3,"file":"pin.js","sourceRoot":"../../..","sources":["components/ux/pin/pin.ts"],"sourcesContent":["import { getRect, setRect, Rect, getStyle } from \"ux/dom\";\r\nimport { scrollParent } from \"ux/scroll\";\r\n\r\nconst knownAligns = {\r\n    center: \"cc-cc\",\r\n    leftTop: \"ll-tb\",\r\n    left: \"ll-cc\",\r\n    leftBottom: \"ll-bt\",\r\n    rightBottom: \"lr-bb\",\r\n    right: \"rr-cc\",\r\n    rightTop: \"rr-tb\",\r\n    topRight: \"rl-tt\",\r\n    top: \"cc-tt\",\r\n    topLeft: \"lr-tt\",\r\n    bottomLeft: \"lr-bb\",\r\n    bottom: \"cc-bb\",\r\n    bottomRight: \"rl-bb\"\r\n};\r\n\r\n/**\r\n * 表示对齐的位置。\r\n * @desc\r\n * 位置使用格式为“xx-yy”的字符串表示。\r\n *\r\n * 其中 xx 表示水平方向的位置，可取以下值之一：\r\n * - `ll`: 对齐到 `target` 左边框的左侧。\r\n * - `lr`: 对齐到 `target` 左边框的右侧。\r\n * - `cc`: 对齐到 `target` 水平居中位置。\r\n * - `rl`: 对齐到 `target` 右边框的左侧。\r\n * - `rr`: 对齐到 `target` 右边框的右侧。\r\n *\r\n * 其中 yy 表示垂直方向的位置，可取以下值之一：\r\n * - `tt`: 对齐到 `target` 上边框的上侧。\r\n * - `tb`: 对齐到 `target` 上边框的下侧。\r\n * - `cc`: 对齐到 `target` 垂直居中位置。\r\n * - `bt`: 对齐到 `target` 下边框的上侧。\r\n * - `bb`: 对齐到 `target` 下边框的下侧。\r\n *\r\n * 对于常见的位置，也可以直接使用下图中的字符串表示：\r\n * ```\r\n * |        topLeft   top   topRight\r\n * |           ┌───────────────┐\r\n * |   leftTop │               │ rightTop\r\n * |           │               │\r\n * |      left │     center    │ right\r\n * |           │               │\r\n * |leftBottom │               │ rightBottom\r\n * |           └───────────────┘\r\n * |     bottomLeft bottom bottomRight\r\n * ```\r\n */\r\nexport type PinAlign = keyof typeof knownAligns | PinResult[\"align\"];\r\n\r\n/**\r\n * 将元素对齐到其它节点或区域。\r\n * @param elem 要定位的元素。\r\n * @param target 对齐的目标节点或区域。\r\n * @param align 对齐的位置。\r\n * @param margin 元素的外边距。如果小于 1，则表示相对元素大小的百分比。\r\n * @param container 容器节点或区域，定位超出容器后会自动调整。如果为 null 则不自动调整位置。\r\n * @param containerPadding 容器的内边距。\r\n * @param offset 定位后的额外偏移距离。如果小于 1，则表示相对元素大小的百分比。\r\n * @param resize 如果容器比元素小，是否允许更改元素大小。\r\n * @return 返回定位结果。\r\n * @example pin(document.getElementById(\"pin_elem\"), document.getElementById(\"pin_target\"))\r\n */\r\nexport default function pin(elem: HTMLElement, target: Document | HTMLElement | Rect, align: PinAlign = \"bottomLeft\", margin = 0, container: Document | HTMLElement | Rect | null = scrollParent(elem), containerPadding = 10, offset = 0, resize = /^(?:auto|scroll)$/.test(getStyle(elem, \"overflow\"))) {\r\n\r\n    // 如果上一次定位更新了大小则先恢复默认大小。\r\n    if (resize !== false) {\r\n        const style = elem.style;\r\n        if ((style as any).__width__ != null) {\r\n            style.width = (style as any).__width__;\r\n            delete (style as any).__width__;\r\n        }\r\n        if ((style as any).__height__ != null) {\r\n            style.height = (style as any).__height__;\r\n            delete (style as any).__height__;\r\n        }\r\n    }\r\n\r\n    // 计算相关的矩形。\r\n    const result = getRect(elem) as PinResult;\r\n    result.align = align = (knownAligns[align as keyof typeof knownAligns] || align) as PinResult[\"align\"];\r\n    result.target = target = (target as Document | HTMLElement).nodeType ? getRect(target as Document | HTMLElement) : target as Rect;\r\n    if (container) {\r\n        result.container = container = (container as Document | HTMLElement).nodeType ? getRect(container as Document | HTMLElement) : { ...container as Rect };\r\n        container.x += containerPadding;\r\n        container.y += containerPadding;\r\n        container.width -= containerPadding + containerPadding;\r\n        container.height -= containerPadding + containerPadding;\r\n    }\r\n\r\n    const proc = (x: \"x\" | \"y\", width: \"width\" | \"height\", center: boolean, left1: boolean, left2: boolean, offset: number) => {\r\n\r\n        // 检测是否超出容器大小。\r\n        if (resize && container && result[width] > (container as Rect)[width]) {\r\n            result[\"scale\" + x.toUpperCase() as \"scaleX\" | \"scaleY\"] = true;\r\n            (elem.style as any)[\"__\" + width + \"__\"] = elem.style[width];\r\n            result[width] = (container as Rect)[width];\r\n        }\r\n\r\n        // 计算实际偏移。\r\n        if (offset && offset < 1 && offset > -1) {\r\n            offset *= result[width];\r\n        }\r\n\r\n        // 计算理论位置。\r\n        let value = (target as Rect)[x] + (center ?\r\n            ((target as Rect)[width] - result[width]) / 2 + offset :\r\n            (left1 ? 0 : (target as Rect)[width]) + (left2 ? -result[width] - offset : offset));\r\n\r\n        // 检测位置是否超出容器。\r\n        if (container) {\r\n            const leftBound = (container as Rect)[x];\r\n            const rightBound = leftBound + (container as Rect)[width] - result[width];\r\n            if ((left2 || center) && value < leftBound || (!left2 || center) && value > rightBound) {\r\n                if (center) {\r\n                    value = value <= rightBound ? Math.min((target as Rect)[x] + (target as Rect)[width] / 2, leftBound) : Math.max((target as Rect)[x] + (target as Rect)[width] / 2 - result[width], rightBound);\r\n                } else {\r\n                    // 对于左右边对齐的布局，先尝试翻转布局。\r\n                    const rotateX = \"rotate\" + x.toUpperCase() as \"rotateX\" | \"rotateY\";\r\n                    if (!result[rotateX]) {\r\n                        result[rotateX] = true;\r\n                        proc(x, width, center, !left1, !left2, offset);\r\n                        return;\r\n                    }\r\n\r\n                    // 如果翻转后仍然超出位置再移动位置。\r\n                    value = left1 ? Math.min((target as Rect)[x], leftBound) : Math.max((target as Rect)[x] + (target as Rect)[width] - result[width], rightBound);\r\n                }\r\n                result[\"transform\" + x.toUpperCase() as \"transformX\" | \"transformY\"] = true;\r\n            }\r\n        }\r\n\r\n        // 对位置进行四舍五入以避免因 < 1px 误差产生的抖动。\r\n        result[x] = Math.round(value);\r\n    };\r\n\r\n    const center = align.charCodeAt(0) === 99 /*c*/;\r\n    const left1 = align.charCodeAt(0) === 108 /*l*/;\r\n    const left2 = align.charCodeAt(1) === 108 /*l*/;\r\n\r\n    const middle = align.charCodeAt(3) === 99 /*c*/;\r\n    const top1 = align.charCodeAt(3) === 116 /*t*/;\r\n    const top2 = align.charCodeAt(4) === 116 /*t*/;\r\n\r\n    proc(\"x\", \"width\", center, left1, left2, center || left1 !== left2 && top1 === top2 ? offset : margin);\r\n    proc(\"y\", \"height\", middle, top1, top2, middle || top1 !== top2 && left1 === left2 ? offset : margin);\r\n    setRect(elem, result.scaleX || result.scaleY ? result : { x: result.x, y: result.y });\r\n    return result;\r\n}\r\n\r\n/**\r\n * 表示定位的结果。\r\n */\r\nexport interface PinResult extends Rect {\r\n\r\n    /**\r\n     * 目标区域。\r\n     */\r\n    target: Rect;\r\n\r\n    /**\r\n     * 容器区域。\r\n     */\r\n    container: Rect;\r\n\r\n    /**\r\n     * 对齐方式。\r\n     */\r\n    align: \"ll-tt\" | \"ll-tb\" | \"ll-cc\" | \"ll-bt\" | \"ll-bb\" | \"lr-tt\" | \"lr-tb\" | \"lr-cc\" | \"lr-bt\" | \"lr-bb\" | \"cc-tt\" | \"cc-tb\" | \"cc-cc\" | \"cc-bt\" | \"cc-bb\" | \"rl-tt\" | \"rl-tb\" | \"rl-cc\" | \"rl-bt\" | \"rl-bb\" | \"rr-tt\" | \"rr-tb\" | \"rr-cc\" | \"rr-bt\" | \"rr-bb\";\r\n\r\n    /**\r\n     * 是否水平翻转了位置。\r\n     */\r\n    rotateX?: boolean;\r\n\r\n    /**\r\n     * 是否垂直翻转了位置。\r\n     */\r\n    rotateY?: boolean;\r\n\r\n    /**\r\n     * 是否调整了水平位置。\r\n     */\r\n    transformX?: boolean;\r\n\r\n    /**\r\n     * 是否调整了垂直位置。\r\n     */\r\n    transformY?: boolean;\r\n\r\n    /**\r\n     * 是否调整了宽度。\r\n     */\r\n    scaleX?: boolean;\r\n\r\n    /**\r\n     * 是否调整了高度。\r\n     */\r\n    scaleY?: boolean;\r\n\r\n}\r\n"],"mappings":"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"}