{"version":3,"file":"drop.js","sourceRoot":"../../..","sources":["components/ux/drop/drop.ts"],"sourcesContent":["import { getRect } from \"ux/dom\";\r\nimport { Draggable } from \"ux/drag\";\r\n\r\n/**\r\n * 表示一个可拖放区域。\r\n */\r\nexport class Droppable {\r\n\r\n    /**\r\n     * 任意元素拖动开始事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则当前拖动区域不响应指定元素的拖放相关事件。\r\n     */\r\n    onDragStart?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 拖动进入事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则忽略本次拖动进入操作。\r\n     */\r\n    onDragEnter?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 在当前区域拖动移动事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDragMove?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 拖动离开事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     * @return 如果返回 false 则忽略本次拖动离开操作。\r\n     */\r\n    onDragLeave?: (draggable: Draggable, e: MouseEvent, sender: this) => boolean | void;\r\n\r\n    /**\r\n     * 拖放事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDrop?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 任意元素拖动结束事件。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    onDragEnd?: (draggable: Draggable, e: MouseEvent, sender: this) => void;\r\n\r\n    /**\r\n     * 所有拖放区域。\r\n     */\r\n    static instances: Droppable[] = [];\r\n\r\n    /**\r\n     * 本次拖动操作可拖放的所有区域。\r\n     */\r\n    static current: Droppable[] | null;\r\n\r\n    /**\r\n     * 处理拖动开始事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragStart(e: MouseEvent, sender: Draggable) {\r\n        Droppable.current = Droppable.instances.filter(droppable => !droppable.onDragStart || droppable.onDragStart(sender, e, droppable) !== false);\r\n    }\r\n\r\n    /**\r\n     * 处理拖动移动事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragMove(e: MouseEvent, sender: Draggable) {\r\n        for (const droppable of Droppable.current!) {\r\n            if (droppable.contains(sender, e)) {\r\n                if (droppable.active) {\r\n                    droppable.onDragMove && droppable.onDragMove(sender, e, droppable);\r\n                } else if (!droppable.onDragEnter || droppable.onDragEnter(sender, e, droppable) !== false) {\r\n                    droppable.active = true;\r\n                }\r\n            } else if (droppable.active && (!droppable.onDragLeave || droppable.onDragLeave(sender, e, droppable) !== false)) {\r\n                droppable.active = false;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理拖动结束事件。\r\n     * @param e 事件对象。\r\n     * @param sender 事件源。\r\n     */\r\n    static handleDragEnd(e: MouseEvent, sender: Draggable) {\r\n        for (const droppable of Droppable.current!) {\r\n            droppable.onDragEnd && droppable.onDragEnd(sender, e, droppable);\r\n            if (droppable.active) {\r\n                droppable.active = false;\r\n                droppable.onDrop && droppable.onDrop(sender, e, droppable);\r\n            }\r\n        }\r\n        Droppable.current = null;\r\n    }\r\n\r\n    /**\r\n     * 拖放的元素。\r\n     */\r\n    elem: HTMLElement;\r\n\r\n    /**\r\n     * 启用拖放。\r\n     */\r\n    enable() {\r\n        const index = Droppable.instances.indexOf(this);\r\n        if (index < 0) {\r\n            Droppable.instances.push(this);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 禁用拖放。\r\n     */\r\n    disable() {\r\n        const index = Droppable.instances.indexOf(this);\r\n        if (index >= 0) {\r\n            Droppable.instances.splice(index, 1);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 判断当前区域是否包含拖动对象。\r\n     */\r\n    protected active: boolean;\r\n\r\n    /**\r\n     * 判断指定的拖动元素是否已进入当前拖放区域。\r\n     * @param draggable 当前的拖动元素。\r\n     * @param e 事件对象。\r\n     * @return 如果在区域内则返回 true，否则返回 false。\r\n     */\r\n    contains(draggable: Draggable, e: MouseEvent) {\r\n        const rect = getRect(this.elem);\r\n        return rect.x <= draggable.endX && draggable.endX <= rect.x + rect.width && rect.y <= draggable.endY && draggable.endY <= rect.y + rect.height;\r\n    }\r\n\r\n}\r\n\r\nfunction connect(dragEvent: string, dropEvent: string) {\r\n    const old = (Draggable.prototype as any)[dragEvent];\r\n    (Draggable.prototype as any)[dragEvent] = function (e: MouseEvent) {\r\n        const result = old.call(this, e);\r\n        (Droppable as any)[dropEvent](e, this);\r\n        return result;\r\n    };\r\n}\r\nconnect(\"dragStart\", \"handleDragStart\");\r\nconnect(\"dragMove\", \"handleDragMove\");\r\nconnect(\"dragEnd\", \"handleDragEnd\");\r\n\r\n/**\r\n * 创建一个新的可拖放区域。\r\n * @param elem 要拖放的元素。\r\n * @param options 拖放的选项。\r\n * @return 返回一个可拖放区域。\r\n */\r\nexport default function droppable(elem: HTMLElement, options?: Partial<Droppable>) {\r\n    const result = new Droppable();\r\n    result.elem = elem;\r\n    Object.assign(result, options);\r\n    result.enable();\r\n    return result;\r\n}\r\n"],"mappings":"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"}