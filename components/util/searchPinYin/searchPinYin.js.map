{"version":3,"file":"searchPinYin.js","sourceRoot":"../../..","sources":["components/util/searchPinYin/searchPinYin.ts"],"sourcesContent":["import { getPinYinOfChar } from \"util/pinyin\";\r\nimport { encodeHTML } from \"util/html\";\r\n\r\n/**\r\n * 搜索列表中匹配的项。\r\n * @param inputs 输入的项。\r\n * @param search 搜索的内容。\r\n * @param markStart 标记匹配开始的符号。\r\n * @param markEnd 标记匹配结束的符号。\r\n * @param encoder 编码内容的回调函数。\r\n * @param cache 提供缓存对象加速第二次解析。\r\n * @return 返回搜索的结果。\r\n */\r\nexport default function searchPinYin(inputs: string[], search: string, markStart = \"<mark>\", markEnd = \"</mark>\", encoder = encodeHTML, cache: { [key: string]: any } = { __proto__: null }) {\r\n    search = search.trim().toLowerCase();\r\n    const result: (Match[] & { html: string, index: number })[] = [];\r\n    for (let i = 0; i < inputs.length; i++) {\r\n        const m = matchPinYin(inputs[i], search, cache) as typeof result[0];\r\n        if (m.length) {\r\n            m.index = i;\r\n            m.html = toHtml(inputs[i], m, markStart, markEnd, encoder);\r\n            result.push(m);\r\n        }\r\n    }\r\n    result.sort(compare);\r\n    return result;\r\n}\r\n\r\n/**\r\n * 匹配拼音。\r\n * @param input 输入的内容。\r\n * @param pattern 匹配的内容。\r\n * @param cache 提供缓存对象加速第二次解析。\r\n * @return 返回所有匹配项数组。如果不匹配则返回空数组。\r\n */\r\nexport function matchPinYin(input: string, pattern: string, cache: { [key: string]: any } = { __proto__: null }) {\r\n    let info = cache[input];\r\n    if (!info) {\r\n        cache[input] = info = {\r\n            chars: [],\r\n            pinyins: []\r\n        };\r\n        input = input.toLowerCase();\r\n        for (let i = 0; i < input.length; i++) {\r\n            info.chars.push(input.charCodeAt(i));\r\n            info.pinyins.push(getPinYinOfChar(input.charAt(i)));\r\n        }\r\n    }\r\n\r\n    const result = [] as Match[];\r\n    next: for (let i = 0; i < info.chars.length; i++) {\r\n        let charIndex = i;\r\n        let patternIndex = 0;\r\n        let level = 0;\r\n        while (patternIndex < pattern.length) {\r\n            if (charIndex >= info.chars.length) {\r\n                continue next;\r\n            }\r\n            if (info.chars[charIndex] === pattern.charCodeAt(patternIndex)) {\r\n                patternIndex++;\r\n                level++;\r\n            } else {\r\n                let matchCount: number | undefined;\r\n                for (const pinyin of info.pinyins[charIndex]) {\r\n                    matchCount = searchStart(pinyin, pattern, patternIndex);\r\n                    if (matchCount) {\r\n                        patternIndex += matchCount;\r\n                        break;\r\n                    }\r\n                }\r\n                if (!matchCount) {\r\n                    continue next;\r\n                }\r\n            }\r\n            charIndex++;\r\n        }\r\n        result.push({ level: level, start: i, end: charIndex });\r\n        i = charIndex;\r\n    }\r\n    return result;\r\n}\r\n\r\n/**\r\n * 搜索字符串中以指定字符开始的连续字符数。\r\n * @param value 要搜索的字符串。\r\n * @param child 要搜索的子字符串。\r\n * @param childIndex *child* 中开始搜索的索引。\r\n * @return 返回最大匹配的字符数。如果无匹配则返回 0。\r\n */\r\nexport function searchStart(value: string, child: string, childIndex: number) {\r\n    let result = 0;\r\n    while (result < value.length && childIndex + result < child.length && value.charCodeAt(result) === child.charCodeAt(childIndex + result)) {\r\n        result++;\r\n    }\r\n    return result;\r\n}\r\n\r\n/**\r\n * 表示一个匹配项。\r\n */\r\nexport interface Match {\r\n\r\n    /**\r\n     * 匹配度。\r\n     */\r\n    level: number;\r\n\r\n    /**\r\n     * 匹配的开始索引。\r\n     */\r\n    start: number;\r\n\r\n    /**\r\n     * 匹配的结束索引。\r\n     */\r\n    end: number;\r\n\r\n}\r\n\r\n/**\r\n * 比较两个匹配结果。\r\n * @param result1 要比较的第一个结果。\r\n * @param result2 要比较的第二个结果。\r\n * @return 如果 result1 更匹配则返回 -1，如果 result2 更匹配则返回 1，如果 result1 和 result2 匹配度相当则返回 0。\r\n */\r\nfunction compare(result1: Match[], result2: Match[]) {\r\n    if (result1.length && result2.length && result1[0].start !== result2[0].start) {\r\n        return result2[0].end - result1[0].end;\r\n    }\r\n    return result2.length - result1.length;\r\n}\r\n\r\n/**\r\n * 根据匹配的结果获取输入高亮后的 HTML 代码。\r\n * @param input 输入的内容。\r\n * @param matchResult 匹配的结果。\r\n * @param markStart 标记匹配开始的符号。\r\n * @param markEnd 标记匹配结束的符号。\r\n * @param encoder 编码内容的回调函数。\r\n * @return 返回 HTML 片段。\r\n */\r\nexport function toHtml(input: string, matchResult: Match[], markStart = \"<mark>\", markEnd = \"</mark>\", encoder = encodeHTML) {\r\n    for (let i = matchResult.length; i-- > 0;) {\r\n        const match = matchResult[i];\r\n        input = encoder(input.slice(0, match.start)) + markStart + encoder(input.slice(match.start, match.end)) + markEnd + (i === matchResult.length - 1 ? encoder(input.slice(match.end)) : input.slice(match.end));\r\n    }\r\n    return input;\r\n}\r\n"],"mappings":"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"}